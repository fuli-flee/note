[toc]

***
# 一. 基础光照

## 1.1 Phone
冯氏光照模型的主要结构由3个分量组成：
- 环境(Ambient)
- 漫反射(Diffuse)
- 镜面(Specular)

<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-26_09-04-01.jpg)

</center>

这个模型是一个经验模型, 是不符合能量守恒的

## 1.2 漫反射光照

两个单位向量的夹角越小，它们点乘的结果越倾向于1。当两个向量的夹角为90度的时候，点乘会变为0。
这同样适用于θ，θ越大，光对片段颜色的影响就应该越小

<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-26_09-19-57.jpg)

</center>

所以，计算漫反射光照需要什么？

- 法向量：一个垂直于顶点表面的向量。
- 定向的光线：作为光源的位置与片段的位置之间向量差的方向向量。为了计算这个光线，我们需要光的位置向量和片段的位置向量。

## 1.3 镜面光照
<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-26_21-03-27.jpg)

</center>

我们通过根据法向量翻折入射光的方向来计算反射向量。然后我们计算反射向量与观察方向的角度差，它们之间夹角越小，镜面光的作用就越大。由此产生的效果就是，我们看向在入射光在表面的反射方向时，会看到一点高光。

***
# 二. 材质

在现实世界里，每个物体会对光产生不同的反应。
当描述一个表面时，我们可以分别为三个光照分量定义一个材质颜色(Material Color)：
- 环境光照(Ambient Lighting)
- 漫反射光照(Diffuse Lighting)
- 镜面光照(Specular Lighting)

通过为每个分量指定一个颜色，我们就能够对表面的颜色输出有细粒度的控制了。现在，我们再添加一个**反光度(Shininess)**分量，结合上述的三个颜色，我们就有了全部所需的材质属性了

[各类材质的值](http://devernay.free.fr/cours/opengl/materials.html)
<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-27_15-33-26.jpg)

</center>

**对于材质的理解:**
材质就是对光的反射特性

比如说：在阳光下，树叶是绿色的，并不是树叶发出了绿色的光，而是树叶吸收了其他颜色的光，反射绿色的光。
剥离掉树叶这种物质，提取出树叶对光“处理”的特性，这就叫树叶材质。

一般我们使用 漫反射光、镜面反射光、光泽度等属性，来定义一种材质，其实我不喜欢这样的称呼，我更喜欢称作 漫反射率， 镜面反射率。

比如树叶的漫反射率(0.54, 0.89, 0.63), 可以这么理解，
树叶可以反射光照中: 54%的红色光，89%的绿色光，63%的蓝色光，
树叶可以吸收光照中: 1-54%的红色光，1-89%的绿色光，1-63%的蓝色光

***
# 三. 投光物(Light casters)
我们目前使用的光照都来自于空间中的一个点。它能给我们不错的效果，但现实世界中，我们有很多种类的光照，每种的表现都不同。将光**投射**(Cast)到物体的光源叫做投光物(Light Caster)。

## 3.1 定向光(Directional Light)
当一个光源处于很远的地方时，来自光源的每条光线就会近似于互相平行。不论物体和/或者观察者的位置，看起来好像所有的光都来自于同一个方向。当我们使用一个假设光源处于**无限远处**的模型时，它就被称为**定向光**，因为它的所有光线都有着相同的方向，它与光源的位置是没有关系的。
所以我们可以定义一个光线方向向量而不是位置向量来模拟一个定向光。
<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-28_16-41-49.jpg)

</center>

## 3.2 点光源(Point Light)
随着光线传播距离的增长逐渐削减光的强度通常叫做**衰减**(Attenuation)。随距离减少光强度的一种方式是使用一个线性方程。这样的方程能够随着距离的增长线性地减少光的强度，从而让远处的物体更暗。然而，这样的线性方程通常会看起来比较假。在现实世界中，灯在近处通常会非常亮，但随着距离的增加光源的亮度一开始会下降非常快，但在远处时剩余的光强度就会下降的非常缓慢了。所以，我们需要一个不同的公式来减少光的强度。

**点光源衰减公式（Point Light Attenuation Formula）**
$$F_{att}=\frac{1.0}{K_c+K_l*d+K_q*d^2}$$


\(F_{att}\) 是衰减因子；\(K_c\) 是常数项；\(K_l\) 是一次项；\(K_q\) 是二次项；d 是光源到物体的距离。
- 常数项通常保持为1.0，它的主要作用是保证分母永远不会比1小，否则的话在某些距离上它反而会增加强度，这肯定不是我们想要的效果。
- 一次项会与距离值相乘，以线性的方式减少强度。
- 二次项会与距离的平方相乘，让光源以二次递减的方式减少强度。二次项在距离比较小的时候影响会比一次项小很多，但当距离值比较大的时候它就会比一次项更大了。

由于二次项的存在，光线会在大部分时候以线性的方式衰退，直到距离变得足够大，让二次项超过一次项，光的强度会以更快的速度下降。这样的结果就是，光在近距离时亮度很高，但随着距离变远亮度迅速降低，最后会以更慢的速度减少亮度。下面这张图显示了在100的距离内衰减的效果：
<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-28_17-08-24.jpg)

</center>

现在的问题是该对这三个项设置什么值呢？[有表](https://wiki.ogre3d.org/tiki-index.php?page=-Point+Light+Attenuation)

一般用距离32-100就够了

|距离|常数项|一次项	|二次项|
|---|---|---|---|
|7	|  1.0  |0.7    |1.8|
|13	|  1.0  |0.35   |0.44|
|20	|  1.0  |0.22   |0.20|
|32	|  1.0  |0.14   |0.07|
|50	|  1.0  |0.09   |0.032|
|65	|  1.0  |0.07   |0.017|
|100|  1.0  |0.045  |0.0075|

## 3.3 聚光(Spotlight)
聚光是位于环境中某个位置的光源，它只朝一个特定方向而不是所有方向照射光线。这样的结果就是只有在聚光方向的特定半径内的物体才会被照亮，其它的物体都会保持黑暗。聚光很好的例子就是路灯或手电筒。
OpenGL中聚光是用一个世界空间位置、一个方向和一个 **切光角(Cutoff Angle)** 来表示的，切光角指定了聚光的半径(是圆锥的半径不是距光源距离那个半径)。对于每个片段，我们会计算片段是否位于聚光的切光方向之间（也就是在锥形内），如果是的话，我们就会相应地照亮片段。下面这张图会让你明白聚光是如何工作的：
<center>

![alt text](/LearnOpenGL/图片/光照/Illumination11-28_18-59-59.jpg)

</center>

- `LightDir`：从片段指向光源的向量。
- `SpotDir`：聚光所指向的方向。
- `Phiϕ`：指定了聚光半径的切光角。落在这个角度之外的物体都不会被这个聚光所照亮。
- `Thetaθ`：LightDir向量和SpotDir向量之间的夹角。在聚光内部的话θ值应该比ϕ值小。

### 3.3.1 平滑/软化边缘
为了创建一种看起来边缘平滑的聚光，我们需要模拟聚光有一个内圆锥(Inner Cone)和一个外圆锥(Outer Cone)。

$$I=\frac{\theta-\gamma}{\epsilon}$$

这里ϵ(Epsilon)是内（ϕ）和外圆锥（γ）之间的余弦值差（ϵ=ϕ−γ）。最终的I值就是在当前片段聚光的强度。


|θ  | θ（角度）|	ϕ（内光切）|	ϕ（角度）|	γ（外光切）|	γ（角度）	|ϵ |  I|
|---|---|---|---|---|---|---|---|
|0.87	|30	|0.91	|25	|0.82	|35	|0.91 - 0.82 = 0.09	|0.87 - 0.82 / 0.09 = 0.56|
|0.9	|26|	0.91|	25|	0.82|	35|	0.91 - 0.82 = 0.09|	0.9 - 0.82 / 0.09 = 0.89|
|0.97|	14|	0.91|	25|	0.82|	35|	0.91 - 0.82 = 0.09|	0.97 - 0.82 / 0.09 = 1.67|
|0.83|	34|	0.91|	25|	0.82|	35|	0.91 - 0.82 = 0.09|	0.83 - 0.82 / 0.09 = 0.11|
0.64|	50|	0.91|	25|	0.82|	35|	0.91 - 0.82 = 0.09|	0.64 - 0.82 / 0.09 = -2.0|
|0.966|	15|	0.9978|	12.5|	0.953|	17.5|	0.9978 - 0.953 = 0.0448|	0.966 - 0.953 / 0.0448 = 0.29